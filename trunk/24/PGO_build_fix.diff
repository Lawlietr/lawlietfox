# HG changeset patch
# Parent d6b959018d97e8874fffe31d9e7bc74e3cfcac88
# User hua.andy <hua.andy@gmail.com>
"pgo build fixed"


diff --git a/browser/components/build/Makefile.in b/browser/components/build/Makefile.in
--- a/browser/components/build/Makefile.in
+++ b/browser/components/build/Makefile.in
@@ -4,16 +4,19 @@
 
 DEPTH=@DEPTH@
 topsrcdir=@top_srcdir@
 srcdir=@srcdir@
 VPATH=@srcdir@
 
 include $(DEPTH)/config/autoconf.mk
 
+#enable PGO
+MSVC_ENABLE_PGO := 1
+
 SHORT_LIBNAME = brwsrcmp
 IS_COMPONENT = 1
 MODULE_NAME = nsBrowserCompsModule
 FORCE_SHARED_LIB = 1
 
 USE_STATIC_LIBS = 1
 
 ifeq ($(OS_ARCH),WINNT)
diff --git a/gfx/angle/src/libEGL/Makefile.in b/gfx/angle/src/libEGL/Makefile.in
--- a/gfx/angle/src/libEGL/Makefile.in
+++ b/gfx/angle/src/libEGL/Makefile.in
@@ -4,16 +4,19 @@
 
 DEPTH     = @DEPTH@
 topsrcdir = @top_srcdir@
 srcdir    = @srcdir@
 VPATH     = @srcdir@
 
 include $(DEPTH)/config/autoconf.mk
 
+#enable PGO
+MSVC_ENABLE_PGO := 1
+
 # On Windows, we don't automatically get "lib" prepended, but we need it.
 FORCE_SHARED_LIB = 1
 
 # ANGLE uses the STL, so we can't use our derpy STL wrappers.
 STL_FLAGS =
 
 # ANGLE uses exceptions internally, so we need to have exception handling
 # support
diff --git a/gfx/angle/src/libGLESv2/Makefile.in b/gfx/angle/src/libGLESv2/Makefile.in
--- a/gfx/angle/src/libGLESv2/Makefile.in
+++ b/gfx/angle/src/libGLESv2/Makefile.in
@@ -5,16 +5,19 @@
 
 DEPTH     = @DEPTH@
 topsrcdir = @top_srcdir@
 srcdir    = @srcdir@
 VPATH     = @srcdir@
 
 include $(DEPTH)/config/autoconf.mk
 
+#enable PGO
+MSVC_ENABLE_PGO := 1
+
 # On Windows, we don't automatically get "lib" prepended, but we need it.
 FORCE_SHARED_LIB = 1
 
 # ANGLE uses the STL, so we can't use our derpy STL wrappers.
 STL_FLAGS =
 
 # ANGLE uses exceptions internally, so we need to have exception handling
 # support
diff --git a/media/webrtc/trunk/tools/gyp/pylib/gyp/generator/mozmake.py b/media/webrtc/trunk/tools/gyp/pylib/gyp/generator/mozmake.py
--- a/media/webrtc/trunk/tools/gyp/pylib/gyp/generator/mozmake.py
+++ b/media/webrtc/trunk/tools/gyp/pylib/gyp/generator/mozmake.py
@@ -39,16 +39,22 @@ EXTERNALLY_MANAGED_MAKE_FILE := 1
 COMMON_FOOTER = """
 # Skip rules that deal with regenerating Makefiles from Makefile.in files.
 NO_MAKEFILE_RULE = 1
 NO_SUBMAKEFILES_RULE = 1
 
 include $(topsrcdir)/config/rules.mk
 include $(topsrcdir)/ipc/chromium/chromium-config.mk
 include %(common_mk_path)s
+
+ifeq (WINNT_1,$(OS_ARCH)_$(MOZ_PROFILE_GENERATE)$(MOZ_PROFILE_USE))
+# avoid the fatal error of compiler when applying PGO
+COMPILE_CXXFLAGS += -GL-
+COMPILE_CFLAGS += -GL-
+endif
 """
 
 COMMON_MK = """# This file was generated by mozmake.py. Do not edit it directly.
 ifndef COMMON_MK_INCLUDED
 COMMON_MK_INCLUDED := 1
 
 ifdef MOZ_DEBUG
 CFLAGS += $(CPPFLAGS_Debug) $(CFLAGS_Debug)
diff --git a/memory/mozalloc/Makefile.in b/memory/mozalloc/Makefile.in
--- a/memory/mozalloc/Makefile.in
+++ b/memory/mozalloc/Makefile.in
@@ -5,16 +5,19 @@
 
 DEPTH		= @DEPTH@
 topsrcdir	= @top_srcdir@
 srcdir		= @srcdir@
 VPATH		= @srcdir@
 
 include $(DEPTH)/config/autoconf.mk
 
+#enable PGO
+MSVC_ENABLE_PGO := 1
+
 VISIBILITY_FLAGS=
 STL_FLAGS	=
 ifdef _MSC_VER
 STL_FLAGS	= -D_HAS_EXCEPTIONS=0
 endif
 
 DIST_INSTALL 	= 1
 
diff --git a/mozglue/build/Makefile.in b/mozglue/build/Makefile.in
--- a/mozglue/build/Makefile.in
+++ b/mozglue/build/Makefile.in
@@ -7,16 +7,19 @@ DEPTH		= @DEPTH@
 topsrcdir	= @top_srcdir@
 srcdir		= @srcdir@
 VPATH		= @srcdir@
 
 include $(DEPTH)/config/autoconf.mk
 
 DIST_INSTALL = 1
 
+#enable PGO
+MSVC_ENABLE_PGO := 1
+
 # Build mozglue as a shared lib on Windows, OSX and Android.
 # If this is ever changed, update MOZ_SHARED_MOZGLUE in browser/installer/Makefile.in
 ifneq (,$(filter WINNT Darwin Android,$(OS_TARGET)))
 FORCE_SHARED_LIB = 1
 else
 FORCE_STATIC_LIB = 1
 endif
 
diff --git a/security/build/Makefile.in b/security/build/Makefile.in
--- a/security/build/Makefile.in
+++ b/security/build/Makefile.in
@@ -7,16 +7,19 @@ DEPTH		= @DEPTH@
 topsrcdir	= @top_srcdir@
 srcdir		= @srcdir@
 VPATH		= @srcdir@
 
 include $(DEPTH)/config/autoconf.mk
 CC_WRAPPER =
 CXX_WRAPPER =
 
+#enable PGO
+MSVC_ENABLE_PGO := 1
+
 ifdef MOZ_FOLD_LIBS
 # TODO: The library name can be changed when bug 845217 is fixed.
 LIBRARY_NAME = nss3
 FORCE_SHARED_LIB = 1
 endif
 
 default::

diff --git a/dom/bindings/Makefile.in b/dom/bindings/Makefile.in
--- a/dom/bindings/Makefile.in
+++ b/dom/bindings/Makefile.in
@@ -231,8 +231,13 @@ export:: $(binding_header_files)
 distclean::
 	-$(RM) \
         $(binding_header_files) \
         $(binding_cpp_files) \
         $(all_webidl_files) \
         $(globalgen_targets) \
         ParserResults.pkl \
         $(NULL)
+
+ifdef _MSC_VER
+# avoid the fatal error C1001 of compiler when applying PGO to Thunderbird
+COMPILE_CXXFLAGS += -GL-
+endif
